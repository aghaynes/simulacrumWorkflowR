---
title: "Example: Testing Oracle compatible queries in the sql_test function"
author: "Jakob Skelmose, Rasmus Rask, Lars Nielsen, Charles Vesteghem, Jennifer Bartell, Martin BÃ¸gsted"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example Testing Oracle compatible queries in the sql_test function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(simulacrumR)
```

In  this example notebook, we want to demonstrate the cababilities of the sql_test function in the package, which is based on the sqldf library and which creates an temporal sqlite database in the R environment. 

For this demonstration, we use a guide for sql queries published by Health Data Insigt: "Simulacrum Guidance: Getting started with extracting data", which can be found on: https://simulacrum.healthdatainsight.org.uk/wp/wp-content/uploads/2018/11/SQL-Query-Guide.pdf. 


# Setup the database: 

``` {r}
dir <- "C:/Users/p90j/Desktop/Jakob/Data/Simulacrum/simulacrum_v2.1.0/Data/"
# Automated data loading 
data_frames_lists <- read_simulacrum(dir) 

SIM_AV_PATIENT <- data_frames_lists$sim_av_patient
SIM_AV_TUMOUR <- data_frames_lists$sim_av_tumour
SIM_AV_GENE <- data_frames_lists$sim_av_gene
SIM_RTDS_COMBINED <- data_frames_lists$sim_rtds_combined
SIM_RTDS_EPISODE <- data_frames_lists$sim_rtds_episode
SIM_RTDS_EXPOSURE <- data_frames_lists$sim_rtds_exposure
SIM_RTDS_PRESCRIPTION <- data_frames_lists$sim_rtds_prescription
SIM_SACT_CYCLE <- data_frames_lists$sim_sact_cycle
SIM_SACT_DRUG_DETAIL <- data_frames_lists$sim_sact_drug_detail
SIM_SACT_OUTCOME <- data_frames_lists$sim_sact_outcome
SIM_SACT_REGIMEN <- data_frames_lists$sim_sact_regimen
```


```{r}
query <- "SELECT *
FROM SIM_AV_PATIENT
INNER JOIN SIM_AV_TUMOUR ON SIM_AV_PATIENT.patientid = SIM_AV_TUMOUR.patientid;"


print(sql_test(query))
```


# 1. SELECT FROM 
```{r}
qeury <- "SELECT *
FROM SIM_AV_TUMOUR;"

print(sql_test(query))


query2 <- "SELECT diagnosisdatebest, site_icd10_o2
FROM SIM_AV_TUMOUR;"

print(sql_test(query2))
```
```{r}
summary(SIM_AV_TUMOUR)
```

# 2. WHERE
```{R}
query <- "SELECT *                          ###### find the new diagnosisyear variable
FROM SIM_AV_TUMOUR
WHERE diagnosisyear = 2014;
"

print(sql_test(query))


query2 <- "SELECT * 
FROM SIM_AV_TUMOUR
WHERE age>90;"

print(sql_test(query2))

query3 <- "SELECT * 
FROM SIM_AV_TUMOUR
WHERE age BETWEEN 18 AND 100;"

print(sql_test(query3))

query4 <- "SELECT * 
FROM SIM_AV_PATIENT
WHERE vitalstatusdate IS NULL;
"
print(sql_test(query4))

query5 <- "SELECT * 
FROM SIM_AV_TUMOUR
WHERE site_icd10_o2_3char IN ('C33','C34');"

print(sql_test(query5))

query6 <- "SELECT * 
FROM SIM_AV_TUMOUR
WHERE age = 34
AND gender = '2';" # Changed sex to gender (variable name has changed after between Simulacrum v.1.2 and v.2.0)

print(sql_test(query6))

query7 <- "SELECT COUNT (patientid) 
FROM SIM_AV_PATIENT
WHERE DEATHCAUSECODE_1A LIKE UPPER('%c50%');"

print(sql_test(query7))
```

# 3. Ordering 
``` {r}
query <- "SELECT * 
FROM SIM_AV_TUMOUR
ORDER BY diagnosisdatebest DESC;
"

print(sql_test(query))
```

# 4. Counting 
```{r}
query <- "SELECT COUNT(*)
FROM SIM_AV_TUMOUR;"

print(sql_test(query))

query2 <- "SELECT COUNT(*) 
FROM SIM_AV_PATIENT
WHERE vitalstatusdate IS NOT NULL;"

print(sql_test(query2))

query3 <- "SELECT COUNT (*) ,COUNT(tumourid) , COUNT(er_status) 
FROM SIM_AV_TUMOUR;"

print(sql_test(query3))
```

# 5. Counting in groups
```{r}
query <- "SELECT sex, COUNT(*) 
FROM SIMULACRUM.SIM_AV_TUMOUR
GROUP BY sex
ORDER BY sex;"

print(sql_test(query))
```

# 6. Other aggregate functions (avg, min, max)
``` {r}
query <- "
SELECT MAX(age), SUM(age), COUNT(age), AVG(age) 
FROM SIM_AV_TUMOUR;"

print(sql_test(query))

# query2 <- "SELECT diagnosisyear, MAX(age), TO_CHAR (AVG(age),'9,999.99') 
# FROM SIMULACRUM.SIM_AV_TUMOUR
# GROUP BY diagnosisyear
# ORDER BY diagnosisyear; "

# query3 <- "SELECT EXTRACT(YEAR FROM diagnosisdatebest) AS diagnosisyear, MAX(age), 
#TO_CHAR(AV(age),'9,999.99') 
#FROM SIMULACRUM.SIM_AV_TUMOUR
#GROUP BY EXTRACT(YEAR FROM diagnosisdatebest)
#ORDER BY diagnosisyear;"

#query4 <- "SELECT diagnosisdatebest
# , TO_CHAR (diagnosisdatebest,'yyyy/mm/dd')
# , TO_CHAR (diagnosisdatebest,'dd/mm/yyyy')
# , TO_CHAR (diagnosisdatebest,'FMMonth DD, YYYY') 
#FROM SIMULACRUM.SIM_AV_TUMOUR;"
```

# 7. Distinct 
``` {r}
query <- "SELECT COUNT (DISTINCT patientid)
FROM SIM_AV_TUMOUR
WHERE site_icd10_o2_3char IN ('C50','C53','C54','C55','C56')
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014;"

print(sql_test(query))

query2 <- "SELECT COUNT (DISTINCT patientid), site_icd10_o2_3char
FROM SIM_AV_TUMOUR
WHERE site_icd10_o2_3char IN ('C50','C53','C54','C55','C56')
AND EXTRACT(YEAR FROM diagnosisdatebest)= 2014
GROUP BY site_icd10_o2_3char;"

print(sql_test(query2))
```

# 8. Case statements 
``` {r}
query <- "SELECT age, 
CASE 
WHEN age <25 THEN 'Under 25' 
WHEN age <70 THEN '25 - 69'
ELSE '70+' 
END AS agegroup
FROM SIM_AV_TUMOUR;"

print(sql_test(query))

#query2 <- "SELECT patientid,
#CASE WHEN sex IN (2) THEN TO_CHAR(diagnosisdatebest, 'DD/MM/YYY')
#END AS diagdateiffemale
# FROM SIM_AV_TUMOUR
# WHERE site_icd10_o2_3char = 'C50' AND EXTRACT(YEAR FROM
#diagnosisdatebest)= 2014;"


#print(sql_test(query2))
```

# 9. Linking/joining tables 
``` {r}
query <- "SELECT *
 FROM SIM_AV_PATIENT, SIM_AV_TUMOUR;"

print(sql_test(query))

query2 <- "SELECT *
FROM SIM_AV_PATIENT
LEFT OUTER JOIN SIM_AV_TUMOUR
ON SIM_AV_PATIENT.patientid = 
SIM_AV_TUMOUR.patientid;
"

print(sql_test(query2))

query3 <- "SELECT *
FROM SIM_AV_PATIENT p
LEFT OUTER JOIN SIM_AV_TUMOUR t
ON p.patientid = t.patientid;"

print(sql_test(query3))


quey4 <- "SELECT tumourid, laterality
FROM SIM_AV_TUMOUR; "

print(sql_test(query4))
```

# 10. Subqueries 
```{r}
query <- "SELECT * 
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014;"

print(sql_test(query))


query2 <- "SELECT DISTINCT patientid
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014;"

print(sql_test(query2))

query3 <- "SELECT patientid, COUNT(*)
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014
GROUP BY patientid;"

print(sql_test(query3))

query4 <- "WITH breastpatients AS
(SELECT patientid, count(*) 
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014
GROUP BY patientid)
SELECT * FROM breastpatients;"

print(sql_test(query4))

query5 <- "WITH breastpatients AS
(SELECT patientid, count(*) 
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014
GROUP BY patientid)
SELECT COUNT(*)
FROM breastpatients;"

print(sql_test(query5))

query6 <- "WITH breastpatients AS
(SELECT patientid, count(*) as tumourcount
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014
GROUP BY patientid)SELECT tumourcount, count(*) 
FROM breastpatients
GROUP BY tumourcount
ORDER BY tumourcount asc;"


print(sql_test(query6))

query7 <- "SELECT tumourcount, count(*) 
FROM 
(SELECT patientid, count(*) as tumourcount
FROM sim_av_tumour
WHERE site_icd10_o2_3char = 'C50'
AND EXTRACT(YEAR FROM diagnosisdatebest) = 2014
GROUP BY patientid) breastpatients
GROUP BY tumourcount
ORDER BY tumourcount asc;"

print(sql_test(query6))
```
























